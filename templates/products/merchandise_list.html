{# templates/products/merchandise_list.html #}
{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if request.GET.q %}Search Results - {% endif %}
    Merchandise & Gifts - Shop
{% endblock %}

{% block content %}
<div class="shop-wrapper">
    <!-- Breadcrumb -->
    <div class="breadcrumbs-area position-relative">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <div class="breadcrumb-content position-relative section-content">
                        <h3 class="title-3">
                            {% if request.GET.q %}
                                Search Results: "{{ request.GET.q }}"
                            {% else %}
                                Merchandise & Gifts
                            {% endif %}
                        </h3>
                        <ul>
                            <li><a href="{% url 'products:home' %}">Home</a></li>
                            <li>Merchandise</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Merchandise Main Area -->
    <div class="shop-main-area">
        <div class="container container-default custom-area">
            <div class="row flex-row-reverse">
                <!-- ==================== MERCHANDISE GRID ==================== -->
                <div class="col-lg-9 col-12 col-custom widget-mt">
                    <!-- Toolbar -->
                    <div class="shop_toolbar_wrapper mb-4">
                        <div class="shop_toolbar_btn">
                            <button type="button" class="active btn-list" data-role="grid_list"><i class="fa fa-th-list"></i></button>
                            <button type="button" class="btn-grid-3" data-role="grid_3"><i class="fa fa-th"></i></button>
                        </div>
                        <div class="shop-select">
                            <form method="get">
                                <select name="ordering" class="form-control nice-select w-100" onchange="this.form.submit()">
                                    <option value="-created_at" {% if not request.GET.ordering or request.GET.ordering == '-created_at' %}selected{% endif %}>Newest First</option>
                                    <option value="name">Name: A-Z</option>
                                    <option value="-name">Name: Z-A</option>
                                    <option value="price">Price: Low to High</option>
                                    <option value="-price">Price: High to Low</option>
                                    <option value="-stock">Most in Stock</option>
                                </select>
                                {% if request.GET.q %}
                                    <input type="hidden" name="q" value="{{ request.GET.q }}">
                                {% endif %}
                            </form>
                        </div>
                    </div>

                    <!-- Merchandise Cards -->
                    <div class="row shop_wrapper grid_list">
                        {% for item in merchandise_items %}
                        <div class="col-12 col-custom product-area">
                            <div class="single-product position-relative">
                                <!-- Image -->
                                <div class="product-image">
                                    <a class="d-block" href="{{ item.get_absolute_url }}">
                                        {% if item.image %}
                                            <img src="{{ item.image.url }}" alt="{{ item.name }}" class="product-image-1 w-100">
                                            <img src="{{ item.image.url }}" alt="{{ item.name }}" class="product-image-2 position-absolute w-100">
                                        {% else %}
                                            <img src="{% static 'assets/images/merchandise/placeholder.jpg' %}" class="product-image-1 w-100">
                                            <img src="{% static 'assets/images/merchandise/placeholder.jpg' %}" class="product-image-2 position-absolute w-100">
                                        {% endif %}
                                    </a>

                                    {% if item.stock <= 0 %}
                                        <div class="out-of-stock-overlay">
                                            <span>Out of Stock</span>
                                        </div>
                                    {% elif item.stock <= 5 %}
                                        <span class="badge badge-warning position-absolute" style="bottom:10px;left:10px;">
                                            Only {{ item.stock }} left!
                                        </span>
                                    {% endif %}
                                </div>

                                <!-- Main Content -->
                                <div class="product-content">
                                    <div class="product-title">
                                        <h4 class="title-2">
                                            <a href="{{ item.get_absolute_url }}">{{ item.name }}</a>
                                        </h4>
                                    </div>

                                    <div class="price-box">
                                        <span class="regular-price">₵{{ item.price }}</span>
                                    </div>

                                    <!-- Description -->
                                    <p class="merch-description text-muted small mt-2">
                                        {{ item.description|truncatewords:15 }}
                                    </p>

                                    <!-- Stock Status -->
                                    <div class="stock-status mt-2">
                                        {% if item.stock > 0 %}
                                            <small class="text-success">
                                                <i class="fa fa-check-circle"></i> In Stock
                                                {% if item.stock <= 10 %}
                                                    <span class="text-warning">(Low Stock)</span>
                                                {% endif %}
                                            </small>
                                        {% else %}
                                            <small class="text-danger">
                                                <i class="fa fa-times-circle"></i> Out of Stock
                                            </small>
                                        {% endif %}
                                    </div>

                                    <!-- Product ID -->
                                    <div class="product-id mt-1">
                                        <small class="text-muted">
                                            <i class="fa fa-barcode"></i> {{ item.product_id }}
                                        </small>
                                    </div>
                                </div>

                                <!-- Hover Buttons -->
                                <div class="add-action d-flex position-absolute">
                                    {% if item.stock > 0 %}
                                        <a href="{{ item.get_absolute_url }}" title="View Details"><i class="ion-eye"></i></a>
                                    {% else %}
                                        <a href="{{ item.get_absolute_url }}" title="View Details"><i class="ion-eye"></i></a>
                                    {% endif %}
                                    <a href="#" title="Add to Wishlist"><i class="ion-ios-heart-outline"></i></a>
                                </div>

                                <!-- List View Extra -->
                                <div class="product-content-listview">
                                    <h4 class="title-2"><a href="{{ item.get_absolute_url }}">{{ item.name }}</a></h4>
                                    
                                    <div class="price-box mb-2">
                                        <span class="regular-price">₵{{ item.price }}</span>
                                    </div>

                                    <!-- Full Item Info -->
                                    <div class="merch-meta mb-3">
                                        <div class="d-flex flex-wrap">
                                            <span class="text-muted mr-3">
                                                <i class="fa fa-barcode"></i> SKU: {{ item.product_id }}
                                            </span>
                                            <span class="text-muted">
                                                <i class="fa fa-archive"></i> Stock: {{ item.stock }}
                                            </span>
                                        </div>
                                    </div>

                                    <p class="desc-content">{{ item.description|truncatewords:30 }}</p>
                                    
                                    <div class="add-action-listview d-flex">
                                        <a href="{{ item.get_absolute_url }}" title="View Full Details"><i class="ion-eye"></i></a>
                                        <a href="#" title="Add to Wishlist"><i class="ion-ios-heart-outline"></i></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-5">
                            <h4>No merchandise items found</h4>
                            {% if request.GET.q %}
                                <p class="text-muted">No items found for "{{ request.GET.q }}"</p>
                            {% else %}
                                <p class="text-muted">Check back soon for new merchandise!</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Pagination -->
                    {% if is_paginated %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <nav class="pagination pagination-wrap">
                                <ul class="pagination">
                                    {% if page_obj.has_previous %}
                                        <li><a href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.ordering %}&ordering={{ request.GET.ordering }}{% endif %}"><i class="ion-ios-arrow-thin-left"></i></a></li>
                                    {% endif %}
                                    <li class="active"><a>{{ page_obj.number }}</a></li>
                                    {% if page_obj.has_next %}
                                        <li><a href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.ordering %}&ordering={{ request.GET.ordering }}{% endif %}"><i class="ion-ios-arrow-thin-right"></i></a></li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <!-- ==================== END MERCHANDISE GRID ==================== -->

                <!-- ==================== SIDEBAR ==================== -->
                <div class="col-lg-3 col-12 col-custom">
                    <aside class="sidebar_widget widget-mt">
                        <div class="widget_inner">
                            <!-- Item Count -->
                            <div class="widget-list widget-mb-4">
                                <div class="alert alert-info">
                                    <h5 class="mb-1">Merchandise</h5>
                                    <p class="mb-0 small">{{ page_obj.paginator.count }} item{{ page_obj.paginator.count|pluralize }} available</p>
                                </div>
                            </div>

                            <!-- Search -->
                            <div class="widget-list widget-mb-4">
                                <h3 class="widget-title">Search Merchandise</h3>
                                <div class="search-box">
                                    <form action=".">
                                        <div class="input-group">
                                            <input type="text" name="q" class="form-control" placeholder="Search merchandise..." value="{{ request.GET.q|default:'' }}">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="submit"><i class="fa fa-search"></i></button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Filter by Stock -->
                            <div class="widget-list widget-mb-4">
                                <h3 class="widget-title">Filter by Availability</h3>
                                <ul class="sidebar-list">
                                    <li><a href="?stock=in_stock">In Stock Only</a></li>
                                    <li><a href="?stock=low_stock">Low Stock</a></li>
                                    <li><a href="{% url 'products:merchandise_list' %}">Show All</a></li>
                                </ul>
                            </div>

                            <!-- Shop By -->
                            <div class="widget-list widget-mb-4">
                                <h3 class="widget-title">Shop By</h3>
                                <ul class="sidebar-list">
                                    <li><a href="{% url 'products:product_list' %}">All Products</a></li>
                                    <li><a href="{% url 'products:basket_list' %}">Combo Offers</a></li>
                                    <li><a href="{% url 'products:merchandise_list' %}" class="active">Merchandise & Gifts</a></li>
                                    <li><a href="{% url 'products:recipe_list' %}">Recipes</a></li>
                                </ul>
                            </div>

                            <!-- New Arrivals -->
                            <div class="widget-list">
                                <h3 class="widget-title">New Arrivals</h3>
                                <div class="sidebar-body">
                                    {% for new_item in merchandise_items|slice:":3" %}
                                    <div class="sidebar-product align-items-center mb-3">
                                        <a href="{{ new_item.get_absolute_url }}" class="image">
                                            <img src="{{ new_item.image.url|default:'/static/assets/images/merchandise/placeholder.jpg' }}" alt="{{ new_item.name }}" width="80">
                                        </a>
                                        <div class="product-content">
                                            <h6 class="title-2 mb-1"><a href="{{ new_item.get_absolute_url }}">{{ new_item.name|truncatechars:25 }}</a></h6>
                                            <div class="price-box">
                                                <span class="regular-price">₵{{ new_item.price }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </aside>
                </div>
                <!-- ==================== END SIDEBAR ==================== -->
            </div>
        </div>
    </div>
</div>
{% endblock %}