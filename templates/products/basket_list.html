{# templates/products/basket_list.html #}
{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if request.GET.q %}Search Results - {% endif %}
    Combo Offers - Shop
{% endblock %}

{% block content %}
<div class="shop-wrapper">
    <!-- Breadcrumb -->
    <div class="breadcrumbs-area position-relative">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <div class="breadcrumb-content position-relative section-content">
                        <h3 class="title-3">
                            {% if request.GET.q %}
                                Search Results: "{{ request.GET.q }}"
                            {% else %}
                                Combo Offers
                            {% endif %}
                        </h3>
                        <ul>
                            <li><a href="{% url 'products:home' %}">Home</a></li>
                            <li>Combo Offers</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shop Main Area -->
    <div class="shop-main-area">
        <div class="container container-default custom-area">
            <div class="row flex-row-reverse">
                <!-- ==================== BASKETS GRID ==================== -->
                <div class="col-lg-9 col-12 col-custom widget-mt">
                    <!-- Toolbar -->
                    <div class="shop_toolbar_wrapper mb-4">
                        <div class="shop_toolbar_btn">
                            <button type="button" class="active btn-list" data-role="grid_list"><i class="fa fa-th-list"></i></button>
                            <button type="button" class="btn-grid-3" data-role="grid_3"><i class="fa fa-th"></i></button>
                        </div>
                        <div class="shop-select">
                            <form method="get">
                                <select name="ordering" class="form-control nice-select w-100" onchange="this.form.submit()">
                                    <option value="-created_at" {% if not request.GET.ordering or request.GET.ordering == '-created_at' %}selected{% endif %}>Newest First</option>
                                    <option value="name">Name: A-Z</option>
                                    <option value="-name">Name: Z-A</option>
                                    <option value="price">Price: Low to High</option>
                                    <option value="-price">Price: High to Low</option>
                                    <option value="-discount_percentage">Best Discount</option>
                                </select>
                                {% if request.GET.q %}
                                    <input type="hidden" name="q" value="{{ request.GET.q }}">
                                {% endif %}
                            </form>
                        </div>
                    </div>

                    <!-- Basket Cards -->
                    <div class="row shop_wrapper grid_list">
                        {% for basket in baskets %}
                        <div class="col-12 col-custom product-area">
                            <div class="single-product position-relative">
                                <!-- Image -->
                                <div class="product-image">
                                    <a class="d-block" href="{{ basket.get_absolute_url }}">
                                        {% if basket.image %}
                                            <img src="{{ basket.image.url }}" alt="{{ basket.name }}" class="product-image-1 w-100">
                                            <img src="{{ basket.image.url }}" alt="{{ basket.name }}" class="product-image-2 position-absolute w-100">
                                        {% else %}
                                            <img src="{% static 'assets/images/product/placeholder.jpg' %}" class="product-image-1 w-100">
                                            <img src="{% static 'assets/images/product/placeholder.jpg' %}" class="product-image-2 position-absolute w-100">
                                        {% endif %}
                                    </a>

                                    <!-- Discount Badge -->
                                    {% if basket.discount_percentage > 0 %}
                                        <span class="badge badge-danger position-absolute" style="top:10px;left:10px;">
                                            Save {{ basket.discount_percentage }}%
                                        </span>
                                    {% endif %}

                                    {% if basket.stock <= 0 %}
                                        <div class="out-of-stock-overlay">
                                            <span>Out of Stock</span>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Main Content -->
                                <div class="product-content">
                                    <div class="product-title">
                                        <h4 class="title-2">
                                            <a href="{{ basket.get_absolute_url }}">{{ basket.name }}</a>
                                        </h4>
                                    </div>

                                    <div class="price-box">
                                        <span class="regular-price text-success">₵{{ basket.price }}</span>
                                        {% if basket.total_original_price > basket.price %}
                                            <span class="old-price text-muted ml-2" style="text-decoration: line-through;">₵{{ basket.total_original_price|floatformat:2 }}</span>
                                        {% endif %}
                                    </div>

                                    <!-- Savings Info -->
                                    {% if basket.savings_per_basket > 0 %}
                                        <div class="savings-info mt-2">
                                            <small class="text-success">
                                                <i class="fa fa-tag"></i> Save ₵{{ basket.savings_per_basket|floatformat:2 }}
                                            </small>
                                        </div>
                                    {% endif %}

                                    <!-- Products Count -->
                                    <div class="basket-products-count mt-2">
                                        <small class="text-muted">
                                            <i class="fa fa-cube"></i> Contains {{ basket.included_products.count }} product{{ basket.included_products.count|pluralize }}
                                        </small>
                                    </div>
                                </div>

                                <!-- Hover Buttons -->
                                <div class="add-action d-flex position-absolute">
                                    {% if basket.is_in_stock %}
                                        <a href="{{ basket.get_absolute_url }}" title="View Details"><i class="ion-eye"></i></a>
                                    {% endif %}
                                    <a href="#" title="Add to Wishlist"><i class="ion-ios-heart-outline"></i></a>
                                </div>

                                <!-- List View Extra -->
                                <div class="product-content-listview">
                                    <h4 class="title-2"><a href="{{ basket.get_absolute_url }}">{{ basket.name }}</a></h4>
                                    
                                    <div class="price-box mb-2">
                                        <span class="regular-price text-success">₵{{ basket.price }}</span>
                                        {% if basket.total_original_price > basket.price %}
                                            <span class="old-price text-muted ml-2" style="text-decoration: line-through;">₵{{ basket.total_original_price|floatformat:2 }}</span>
                                        {% endif %}
                                    </div>

                                    {% if basket.savings_per_basket > 0 %}
                                        <p class="text-success mb-2">
                                            <strong>Save ₵{{ basket.savings_per_basket|floatformat:2 }} ({{ basket.discount_percentage }}% off)</strong>
                                        </p>
                                    {% endif %}

                                    <p class="desc-content">{{ basket.description|truncatewords:20 }}</p>
                                    
                                    <!-- Products in Basket -->
                                    <div class="basket-products-list mb-3">
                                        <small class="text-muted d-block mb-1">
                                            <strong>Includes:</strong>
                                        </small>
                                        {% for item in basket.included_products.all|slice:":3" %}
                                            <span class="badge badge-light mr-1 mb-1">{{ item.product.name }} ({{ item.quantity }})</span>
                                        {% endfor %}
                                        {% if basket.included_products.count > 3 %}
                                            <span class="badge badge-secondary">+{{ basket.included_products.count|add:"-3" }} more</span>
                                        {% endif %}
                                    </div>

                                    <div class="add-action-listview d-flex">
                                        <a href="{{ basket.get_absolute_url }}" title="View Details"><i class="ion-eye"></i></a>
                                        <a href="#" title="Add to Wishlist"><i class="ion-ios-heart-outline"></i></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-5">
                            <h4>No combo offers found</h4>
                            {% if request.GET.q %}
                                <p class="text-muted">No combos found for "{{ request.GET.q }}"</p>
                            {% else %}
                                <p class="text-muted">Check back soon for special combo deals!</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Pagination -->
                    {% if is_paginated %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <nav class="pagination pagination-wrap">
                                <ul class="pagination">
                                    {% if page_obj.has_previous %}
                                        <li><a href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.ordering %}&ordering={{ request.GET.ordering }}{% endif %}"><i class="ion-ios-arrow-thin-left"></i></a></li>
                                    {% endif %}
                                    <li class="active"><a>{{ page_obj.number }}</a></li>
                                    {% if page_obj.has_next %}
                                        <li><a href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.ordering %}&ordering={{ request.GET.ordering }}{% endif %}"><i class="ion-ios-arrow-thin-right"></i></a></li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <!-- ==================== END BASKETS GRID ==================== -->

                <!-- ==================== SIDEBAR ==================== -->
                <div class="col-lg-3 col-12 col-custom">
                    <aside class="sidebar_widget widget-mt">
                        <div class="widget_inner">
                            <!-- Basket Count -->
                            <div class="widget-list widget-mb-4">
                                <div class="alert alert-info">
                                    <h5 class="mb-1">Special Combos</h5>
                                    <p class="mb-0 small">{{ page_obj.paginator.count }} combo{{ page_obj.paginator.count|pluralize }} available</p>
                                </div>
                            </div>

                            <!-- Search -->
                            <div class="widget-list widget-mb-4">
                                <h3 class="widget-title">Search Combos</h3>
                                <div class="search-box">
                                    <form action=".">
                                        <div class="input-group">
                                            <input type="text" name="q" class="form-control" placeholder="Search combo offers..." value="{{ request.GET.q|default:'' }}">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="submit"><i class="fa fa-search"></i></button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Shop By -->
                            <div class="widget-list widget-mb-4">
                                <h3 class="widget-title">Shop By</h3>
                                <ul class="sidebar-list">
                                    <li><a href="{% url 'products:product_list' %}">All Products</a></li>
                                    <li><a href="{% url 'products:basket_list' %}" class="active">Combo Offers</a></li>
                                    <li><a href="{% url 'products:merchandise_list' %}">Merchandise & Gifts</a></li>
                                    <li><a href="{% url 'products:recipe_list' %}">Recipes</a></li>
                                </ul>
                            </div>

                            <!-- Best Value Combos -->
                            <div class="widget-list">
                                <h3 class="widget-title">Best Value Combos</h3>
                                <div class="sidebar-body">
                                    {% for best_basket in baskets|slice:":3" %}
                                    <div class="sidebar-product align-items-center mb-3">
                                        <a href="{{ best_basket.get_absolute_url }}" class="image">
                                            <img src="{{ best_basket.image.url|default:'/static/assets/images/product/placeholder.jpg' }}" alt="{{ best_basket.name }}" width="80">
                                        </a>
                                        <div class="product-content">
                                            <h6 class="title-2 mb-1"><a href="{{ best_basket.get_absolute_url }}">{{ best_basket.name|truncatechars:25 }}</a></h6>
                                            <div class="price-box">
                                                <span class="regular-price text-success">₵{{ best_basket.price }}</span>
                                                {% if best_basket.discount_percentage > 0 %}
                                                    <small class="text-danger d-block">Save {{ best_basket.discount_percentage }}%</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </aside>
                </div>
                <!-- ==================== END SIDEBAR ==================== -->
            </div>
        </div>
    </div>
</div>
{% endblock %}