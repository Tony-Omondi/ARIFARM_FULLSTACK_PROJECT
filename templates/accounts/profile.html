{# templates/profile/profile.html #}
{% extends 'base.html' %}
{% load static %}

{% block title %}My Profile - Obrien Organic Shop{% endblock %}

{% block content %}
<div class="shop-wrapper">
    <!-- Breadcrumb Area Start Here -->
    <div class="breadcrumbs-area position-relative">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <div class="breadcrumb-content position-relative section-content">
                        <h3 class="title-3">My Account</h3>
                        <ul>
                            <li><a href="{% url 'products:home' %}">Home</a></li>
                            <li>My Account</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Breadcrumb Area End Here -->

    <!-- My Account Wrapper Start -->
    <div class="my-account-wrapper mt-no-text mb-no-text">
        <div class="container container-default-2 custom-area">
            <div class="row">
                <div class="col-lg-12 col-custom">
                    <!-- My Account Page Start -->
                    <div class="myaccount-page-wrapper">
                        <!-- My Account Tab Menu Start -->
                        <div class="row">
                            <div class="col-lg-3 col-md-4 col-custom">
                                <div class="myaccount-tab-menu nav" role="tablist">
                                    <a href="#dashboad" class="active" data-bs-toggle="tab">
                                        <i class="fa fa-dashboard"></i> Dashboard
                                    </a>
                                    <a href="#orders" data-bs-toggle="tab">
                                        <i class="fa fa-cart-arrow-down"></i> Orders
                                    </a>
                                    <a href="#wishlist" data-bs-toggle="tab">
                                        <i class="fa fa-heart"></i> Wishlist
                                    </a>
                                    <a href="#download" data-bs-toggle="tab">
                                        <i class="fa fa-cloud-download"></i> Downloads
                                    </a>
                                    <a href="#address-edit" data-bs-toggle="tab">
                                        <i class="fa fa-map-marker"></i> Address
                                    </a>
                                    <a href="#account-info" data-bs-toggle="tab">
                                        <i class="fa fa-user"></i> Account Details
                                    </a>
                                    <a href="{% url 'logout' %}">
                                        <i class="fa fa-sign-out"></i> Logout
                                    </a>
                                </div>
                            </div>
                            <!-- My Account Tab Menu End -->

                            <!-- My Account Tab Content Start -->
                            <div class="col-lg-9 col-md-8 col-custom">
                                <div class="tab-content" id="myaccountContent">
                                    <!-- Dashboard Tab Content Start -->
                                    <div class="tab-pane fade show active" id="dashboad" role="tabpanel">
                                        <div class="myaccount-content">
                                            <!-- Profile Header with Picture -->
                                            <div class="profile-header mb-4">
                                                <div class="row align-items-center">
                                                    <div class="col-auto">
                                                        <div class="profile-picture-container">
                                                            {% if user.profile_picture %}
                                                                <img src="{{ user.profile_picture.url }}" 
                                                                     alt="{{ user.get_full_name|default:user.username }}" 
                                                                     class="profile-picture rounded-circle shadow"
                                                                     style="width: 100px; height: 100px; object-fit: cover; border: 4px solid white;">
                                                            {% else %}
                                                                <div class="default-profile-picture rounded-circle d-flex align-items-center justify-content-center shadow"
                                                                     style="width: 100px; height: 100px; background: linear-gradient(135deg, #37582D 0%, #4CAF50 100%); color: white; font-size: 40px;">
                                                                    <i class="fa fa-user"></i>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="col">
                                                        <h3 class="mb-1">Welcome, {{ user.get_full_name|default:user.username }}!</h3>
                                                        <p class="text-muted mb-0">{{ user.email }}</p>
                                                        {% if user.date_joined %}
                                                        <small class="text-muted">
                                                            <i class="fa fa-calendar-alt mr-1"></i>
                                                            Member since {{ user.date_joined|date:"F d, Y" }}
                                                        </small>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-auto">
                                                        <a href="#account-info" class="btn obrien-button-2 primary-color rounded-0" data-bs-toggle="tab">
                                                            <i class="fa fa-edit mr-1"></i> Edit Profile
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Account Stats -->
                                            <div class="row mb-4">
                                                <div class="col-md-4 mb-3">
                                                    <div class="stat-card card border-0 shadow-sm h-100">
                                                        <div class="card-body text-center">
                                                            <div class="stat-icon mb-3">
                                                                <i class="fa fa-shopping-cart fa-2x text-primary"></i>
                                                            </div>
                                                            <h4 class="mb-1">0</h4>
                                                            <p class="text-muted mb-0">Total Orders</p>
                                                            <a href="#orders" data-bs-toggle="tab" class="small text-primary mt-2 d-block">
                                                                View Orders <i class="fa fa-arrow-right ml-1"></i>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <div class="stat-card card border-0 shadow-sm h-100">
                                                        <div class="card-body text-center">
                                                            <div class="stat-icon mb-3">
                                                                <i class="fa fa-heart fa-2x text-danger"></i>
                                                            </div>
                                                            <h4 class="mb-1">0</h4>
                                                            <p class="text-muted mb-0">Wishlist Items</p>
                                                            <a href="#wishlist" data-bs-toggle="tab" class="small text-danger mt-2 d-block">
                                                                View Wishlist <i class="fa fa-arrow-right ml-1"></i>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <div class="stat-card card border-0 shadow-sm h-100">
                                                        <div class="card-body text-center">
                                                            <div class="stat-icon mb-3">
                                                                <i class="fa fa-download fa-2x text-success"></i>
                                                            </div>
                                                            <h4 class="mb-1">0</h4>
                                                            <p class="text-muted mb-0">Downloads</p>
                                                            <a href="#download" data-bs-toggle="tab" class="small text-success mt-2 d-block">
                                                                View Downloads <i class="fa fa-arrow-right ml-1"></i>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Quick Actions -->
                                            <div class="alert alert-info">
                                                <div class="d-flex align-items-center">
                                                    <i class="fa fa-info-circle fa-2x mr-3"></i>
                                                    <div>
                                                        <h5 class="mb-1">Quick Actions</h5>
                                                        <p class="mb-0">From your account dashboard, you can easily manage your orders, wishlist, and account details.</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Recent Activity -->
                                            <div class="recent-activity mt-4">
                                                <h5 class="mb-3"><i class="fa fa-history mr-2"></i> Recent Activity</h5>
                                                <div class="list-group">
                                                    <div class="list-group-item">
                                                        <div class="d-flex w-100 justify-content-between">
                                                            <small>Account Created</small>
                                                            <small>{{ user.date_joined|timesince }} ago</small>
                                                        </div>
                                                        <p class="mb-1">Welcome to Obrien Organic Shop!</p>
                                                    </div>
                                                    {% if user.last_login %}
                                                    <div class="list-group-item">
                                                        <div class="d-flex w-100 justify-content-between">
                                                            <small>Last Login</small>
                                                            <small>{{ user.last_login|timesince }} ago</small>
                                                        </div>
                                                        <p class="mb-1">You last logged in from this device</p>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Dashboard Tab Content End -->

                                    <!-- Orders Tab Content Start -->
                                    <div class="tab-pane fade" id="orders" role="tabpanel">
                                        <div class="myaccount-content">
                                            <h3><i class="fa fa-shopping-cart mr-2"></i> My Orders</h3>
                                            <div class="myaccount-table table-responsive text-center">
                                                <table class="table table-bordered">
                                                    <thead class="thead-light">
                                                        <tr>
                                                            <th>Order</th>
                                                            <th>Date</th>
                                                            <th>Status</th>
                                                            <th>Total</th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td colspan="5" class="text-center py-5">
                                                                <i class="fa fa-shopping-cart fa-3x text-muted mb-3"></i>
                                                                <h5>No Orders Yet</h5>
                                                                <p class="text-muted">You haven't placed any orders yet.</p>
                                                                <a href="{% url 'products:product_list' %}" class="btn obrien-button primary-btn">
                                                                    <i class="fa fa-shopping-bag mr-2"></i> Start Shopping
                                                                </a>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Orders Tab Content End -->

                                    <!-- Wishlist Tab Content Start -->
                                    <div class="tab-pane fade" id="wishlist" role="tabpanel">
                                        <div class="myaccount-content">
                                            <h3><i class="fa fa-heart mr-2"></i> My Wishlist</h3>
                                            <div class="alert alert-warning">
                                                <div class="d-flex align-items-center">
                                                    <i class="fa fa-heart fa-2x mr-3"></i>
                                                    <div>
                                                        <h5 class="mb-1">Your wishlist is empty</h5>
                                                        <p class="mb-0">Save your favorite products here to purchase them later.</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <a href="{% url 'products:product_list' %}" class="btn obrien-button primary-btn">
                                                <i class="fa fa-shopping-bag mr-2"></i> Browse Products
                                            </a>
                                        </div>
                                    </div>
                                    <!-- Wishlist Tab Content End -->

                                    <!-- Downloads Tab Content Start -->
                                    <div class="tab-pane fade" id="download" role="tabpanel">
                                        <div class="myaccount-content">
                                            <h3><i class="fa fa-cloud-download mr-2"></i> My Downloads</h3>
                                            <div class="myaccount-table table-responsive text-center">
                                                <table class="table table-bordered">
                                                    <thead class="thead-light">
                                                        <tr>
                                                            <th>Product</th>
                                                            <th>Date</th>
                                                            <th>Expire</th>
                                                            <th>Download</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td colspan="4" class="text-center py-5">
                                                                <i class="fa fa-cloud-download fa-3x text-muted mb-3"></i>
                                                                <h5>No Downloads Available</h5>
                                                                <p class="text-muted">You haven't purchased any downloadable products yet.</p>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Downloads Tab Content End -->

                                    <!-- Address Edit Tab Content Start -->
                                    <div class="tab-pane fade" id="address-edit" role="tabpanel">
                                        <div class="myaccount-content">
                                            <h3><i class="fa fa-map-marker mr-2"></i> Billing Address</h3>
                                            {% if user.address %}
                                            <div class="address-card card border-0 shadow-sm mb-4">
                                                <div class="card-body">
                                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                                        <h5 class="card-title mb-0">Primary Address</h5>
                                                        <span class="badge bg-success">Default</span>
                                                    </div>
                                                    <address class="mb-0">
                                                        <p><strong>{{ user.get_full_name|default:user.username }}</strong></p>
                                                        <p>{{ user.address }}<br>
                                                        {% if user.county %}{{ user.county }}, {% endif %}
                                                        {% if user.zone %}{{ user.zone }}{% endif %}</p>
                                                        {% if user.phone_number %}
                                                        <p><i class="fa fa-phone mr-2"></i> {{ user.phone_number }}</p>
                                                        {% endif %}
                                                    </address>
                                                </div>
                                            </div>
                                            {% else %}
                                            <div class="alert alert-info mb-4">
                                                <div class="d-flex align-items-center">
                                                    <i class="fa fa-map-marker fa-2x mr-3"></i>
                                                    <div>
                                                        <h5 class="mb-1">No address saved</h5>
                                                        <p class="mb-0">Add your billing address for faster checkout.</p>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                            <a href="#account-info" class="btn obrien-button primary-btn" data-bs-toggle="tab">
                                                <i class="fa fa-edit mr-2"></i> Edit Address
                                            </a>
                                        </div>
                                    </div>
                                    <!-- Address Edit Tab Content End -->

                                    <!-- Account Info Tab Content Start -->
                                    <div class="tab-pane fade" id="account-info" role="tabpanel">
                                        <div class="myaccount-content">
                                            <h3><i class="fa fa-user mr-2"></i> Account Details</h3>
                                            {% if messages %}
                                                {% for message in messages %}
                                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-4">
                                                    {% if message.tags == 'success' %}
                                                    <i class="fa fa-check-circle mr-2"></i>
                                                    {% else %}
                                                    <i class="fa fa-exclamation-circle mr-2"></i>
                                                    {% endif %}
                                                    {{ message }}
                                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                                </div>
                                                {% endfor %}
                                            {% endif %}
                                            
                                            <div class="account-details-form">
                                                <form method="post" enctype="multipart/form-data">
                                                    {% csrf_token %}
                                                    
                                                    <div class="row">
                                                        <div class="col-lg-6 col-custom">
                                                            <div class="single-input-item mb-3">
                                                                <label for="first-name" class="required mb-1">First Name</label>
                                                                {{ form.first_name }}
                                                                {% if form.first_name.errors %}
                                                                <div class="text-danger small mt-1">{{ form.first_name.errors }}</div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-6 col-custom">
                                                            <div class="single-input-item mb-3">
                                                                <label for="last-name" class="required mb-1">Last Name</label>
                                                                {{ form.last_name }}
                                                                {% if form.last_name.errors %}
                                                                <div class="text-danger small mt-1">{{ form.last_name.errors }}</div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="single-input-item mb-3">
                                                        <label for="email" class="required mb-1">Email Address</label>
                                                        <input type="email" id="email" value="{{ user.email }}" disabled class="form-control bg-light" />
                                                        <small class="text-muted">Contact support to change email address</small>
                                                    </div>
                                                    
                                                    <div class="row">
                                                        <div class="col-lg-6 col-custom">
                                                            <div class="single-input-item mb-3">
                                                                <label for="phone" class="mb-1">Phone Number</label>
                                                                {{ form.phone_number }}
                                                                {% if form.phone_number.errors %}
                                                                <div class="text-danger small mt-1">{{ form.phone_number.errors }}</div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-6 col-custom">
                                                            <div class="single-input-item mb-3">
                                                                <label for="zone" class="mb-1">Zone</label>
                                                                {{ form.zone }}
                                                                {% if form.zone.errors %}
                                                                <div class="text-danger small mt-1">{{ form.zone.errors }}</div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="single-input-item mb-3">
                                                        <label for="address" class="mb-1">Address</label>
                                                        {{ form.address }}
                                                        {% if form.address.errors %}
                                                        <div class="text-danger small mt-1">{{ form.address.errors }}</div>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <div class="single-input-item mb-3">
                                                        <label for="county" class="mb-1">County</label>
                                                        {{ form.county }}
                                                        {% if form.county.errors %}
                                                        <div class="text-danger small mt-1">{{ form.county.errors }}</div>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <div class="single-input-item mb-4">
                                                        <label for="profile-picture" class="mb-1">Profile Picture</label>
                                                        <div class="d-flex align-items-center">
                                                            <div class="mr-4">
                                                                {% if user.profile_picture %}
                                                                    <img src="{{ user.profile_picture.url }}" 
                                                                         alt="Current Profile" 
                                                                         class="rounded-circle"
                                                                         style="width: 80px; height: 80px; object-fit: cover; border: 3px solid #dee2e6;">
                                                                {% else %}
                                                                    <div class="rounded-circle d-flex align-items-center justify-content-center"
                                                                         style="width: 80px; height: 80px; background: #f8f9fa; border: 3px solid #dee2e6;">
                                                                        <i class="fa fa-user fa-2x text-muted"></i>
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                            <div class="flex-grow-1">
                                                                {{ form.profile_picture }}
                                                                {% if form.profile_picture.errors %}
                                                                <div class="text-danger small mt-1">{{ form.profile_picture.errors }}</div>
                                                                {% endif %}
                                                                <small class="text-muted mt-2 d-block">Upload a new profile picture (JPG, PNG, max 5MB)</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="single-input-item single-item-button mt-4">
                                                        <button type="submit" class="btn obrien-button primary-btn">
                                                            <i class="fa fa-save mr-2"></i> Save Changes
                                                        </button>
                                                        <a href="#dashboad" class="btn obrien-button-2 primary-color ml-2" data-bs-toggle="tab">
                                                            Cancel
                                                        </a>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Account Info Tab Content End -->
                                </div>
                            </div>
                            <!-- My Account Tab Content End -->
                        </div>
                    </div>
                    <!-- My Account Page End -->
                </div>
            </div>
        </div>
    </div>
    <!-- My Account Wrapper End -->

    <!-- Support Area Start Here -->
    <div class="support-area">
        <div class="container container-default custom-area">
            <div class="row">
                <div class="col-lg-12 col-custom">
                    <div class="support-wrapper d-flex">
                        <div class="support-content">
                            <h1 class="title">Need Help ?</h1>
                            <p class="desc-content">Our customer support team is here to help with any questions about your account.</p>
                        </div>
                        <div class="support-button d-flex align-items-center">
                            <a class="obrien-button primary-btn" href="{% url 'contact' %}">Contact now</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Support Area End Here -->
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Profile picture preview
    const profilePictureInput = document.getElementById('id_profile_picture');
    if (profilePictureInput) {
        profilePictureInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert('File size must be less than 5MB');
                    this.value = '';
                    return;
                }
                
                const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
                if (!validTypes.includes(file.type)) {
                    alert('Only JPG and PNG files are allowed');
                    this.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Update preview image if exists
                    const previewImg = document.querySelector('.profile-picture');
                    if (previewImg) {
                        previewImg.src = e.target.result;
                    }
                }
                reader.readAsDataURL(file);
            }
        });
    }

    // Tab switching with URL hash support
    const urlHash = window.location.hash;
    if (urlHash) {
        const tab = document.querySelector(`.myaccount-tab-menu a[href="${urlHash}"]`);
        if (tab) {
            tab.click();
        }
    }

    // Form validation
    const form = document.querySelector('#account-info form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Add any custom validation here if needed
            return true;
        });
    }

    // Update profile picture on dashboard when changed
    profilePictureInput?.addEventListener('change', function() {
        // This will be reflected after form submission and page reload
        console.log('Profile picture changed, will update on save');
    });
});
</script>

<style>
/* Custom styles to match Obrien theme */
.myaccount-tab-menu {
    background: white;
    border-radius: 10px;
    padding: 0;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    overflow: hidden;
}

.myaccount-tab-menu a {
    display: block;
    padding: 15px 20px;
    border-bottom: 1px solid #f1f1f1;
    color: #333;
    text-decoration: none;
    transition: all 0.3s;
    font-weight: 500;
}

.myaccount-tab-menu a:hover {
    background: #f8f9fa;
    color: #37582D;
    padding-left: 25px;
}

.myaccount-tab-menu a.active {
    background: #37582D;
    color: white;
    border-left: 4px solid #28a745;
}

.myaccount-tab-menu a:last-child {
    border-bottom: none;
    color: #e74c3c;
}

.myaccount-tab-menu a:last-child:hover {
    background: #e74c3c;
    color: white;
}

.myaccount-content {
    background: white;
    border-radius: 10px;
    padding: 30px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

.profile-header {
    background: linear-gradient(135deg, #f8fff8 0%, #f1f8e9 100%);
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 30px;
    border: 1px solid #d4edda;
}

.stat-card {
    transition: transform 0.3s;
    border-radius: 10px;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
}

.stat-icon {
    width: 60px;
    height: 60px;
    background: rgba(55, 88, 45, 0.1);
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.table thead th {
    background: #37582D;
    color: white;
    border: none;
    padding: 15px;
    font-weight: 600;
}

.table tbody td {
    vertical-align: middle;
    padding: 15px;
}

.form-control:focus {
    border-color: #37582D;
    box-shadow: 0 0 0 0.2rem rgba(55, 88, 45, 0.25);
}

.obrien-button {
    background: #37582D;
    border: none;
    padding: 12px 30px;
    border-radius: 5px;
    color: white;
    font-weight: 600;
    transition: all 0.3s;
}

.obrien-button:hover {
    background: #2a4422;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.obrien-button-2 {
    background: transparent;
    border: 1px solid #37582D;
    color: #37582D;
    padding: 10px 25px;
    border-radius: 5px;
    font-weight: 600;
    transition: all 0.3s;
}

.obrien-button-2:hover {
    background: #37582D;
    color: white;
    text-decoration: none;
}

.alert {
    border-radius: 10px;
    border: none;
    padding: 20px;
}

.address-card {
    border-left: 4px solid #37582D !important;
}

.list-group-item {
    border: 1px solid #f1f1f1;
    border-left: 4px solid #37582D;
    margin-bottom: 10px;
    border-radius: 8px;
}

.list-group-item:last-child {
    margin-bottom: 0;
}

/* Profile picture upload styling */
#id_profile_picture {
    padding: 10px;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    width: 100%;
    cursor: pointer;
}

#id_profile_picture:hover {
    border-color: #37582D;
}

.bg-light {
    background-color: #f8f9fa !important;
}
</style>
{% endblock %}